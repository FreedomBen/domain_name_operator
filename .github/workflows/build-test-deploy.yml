name: Build -> Test -> Deploy
on:
  push:
    branches:
      - main
    tags:
      - 'prod-*'

env:
  RELEASE_VERSION: ${{ github.sha }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Image
        run: ./scripts/build-release.sh

      - name: Authenticate to DO Container Registry
        env:
          DOCKER_CONFIG: ${{ secrets.DOCKER_CONFIG }}
        run: |
          mkdir -p $HOME/.docker
          echo "${DOCKER_CONFIG}" > $HOME/.docker/config.json

      - name: Push Image
        run: ./scripts/push-release.sh

  test:
    needs: [build]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to DO Container Registry
        env:
          DOCKER_CONFIG: ${{ secrets.DOCKER_CONFIG }}
        run: |
          mkdir -p $HOME/.docker
          echo "${DOCKER_CONFIG}" > $HOME/.docker/config.json

      - name: Test
        run: ./scripts/run-ci.sh

  ## For now we do not have a staging cluster to target
  #deploy-staging:
  #  runs-on: ubuntu-latest
  #  #if: ${{ endsWith(github.ref, 'main') || endsWith(github.ref, '') }}
  #  env:
  #    ENV: staging
  #    K8S_SERVER: ${{ secrets.K8S_ENDPOINT_STAGING }}
  #    K8S_TOKEN: ${{ secrets.K8S_TOKEN_STAGING }}
  #    K8S_CA_CERT: ${{ secrets.K8S_CA_CERT_STAGING }}
  #    #SLACK_CHANNEL: '#infra-info'
  #    #SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}

  #  steps:
  #    - name: Checkout
  #      uses: actions/checkout@v2

  #    - name: Render Manifests
  #      run: ./scripts/deploy-release.sh --save-deploy --manifest-dir "manifests-${RELEASE_VERSION}-${ENV}" --debug

  #    - name: Archive Rendered Kubernetes Manifests
  #      uses: actions/upload-artifact@v4
  #      with:
  #        name: "manifests-${{ env.RELEASE_VERSION }}-${{ env.ENV }}"
  #        path: "manifests-${{ env.RELEASE_VERSION }}-${{ env.ENV }}"

  #    - name: Deploy new version
  #      run: ./scripts/deploy-release.sh --apply-deploy --manifest-dir "manifests-${RELEASE_VERSION}-${ENV}" --debug

  deploy-prod:
    #needs: [deploy-staging]
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/prod-') }}
    env:
      ENV: prod
      K8S_SERVER: ${{ secrets.K8S_ENDPOINT_PROD }}
      K8S_TOKEN: ${{ secrets.K8S_TOKEN_PROD }}
      K8S_CA_CERT: ${{ secrets.K8S_CA_CERT_PROD }}
      #SLACK_CHANNEL: '#infra-info'
      #SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Render Manifests
        run: ./scripts/deploy-release.sh --save-deploy --manifest-dir "manifests-${RELEASE_VERSION}-${ENV}" --debug

      - name: Archive Rendered Kubernetes Manifests
        uses: actions/upload-artifact@v4
        with:
          name: "manifests-${{ env.RELEASE_VERSION }}-${{ env.ENV }}"
          path: "manifests-${{ env.RELEASE_VERSION }}-${{ env.ENV }}"

      - name: Deploy new version
        run: ./scripts/deploy-release.sh --apply-deploy --manifest-dir "manifests-${RELEASE_VERSION}-${ENV}" --debug

